# テスト仕様書 - 営業日報システム

## 1. テスト概要

### 1.1 目的

営業日報システムの品質を保証し、要件定義に基づいた機能が正しく動作することを確認する。

### 1.2 テスト範囲

- 認証機能
- 日報管理機能
- 訪問記録管理機能
- コメント機能
- 顧客マスタ管理機能
- 営業マスタ管理機能
- ダッシュボード機能

### 1.3 テスト種別

- **単体テスト (UT)**: 個別の関数・メソッドのテスト
- **結合テスト (IT)**: APIエンドポイント、データベース連携のテスト
- **システムテスト (ST)**: エンドツーエンドのシナリオテスト
- **受け入れテスト (UAT)**: ユーザー視点での動作確認

### 1.4 テスト環境

- データベース: テスト用DB（本番データと分離）
- テストデータ: 専用のマスタデータとサンプルデータを使用
- テストユーザー: 営業担当者、上長、管理者の各ロール

---

## 2. テストデータ

### 2.1 営業マスタ（Sales）

| sales_id | sales_name | email              | department | manager_id | 説明           |
| -------- | ---------- | ------------------ | ---------- | ---------- | -------------- |
| 1        | 山田太郎   | yamada@example.com | 営業1課    | 10         | 一般営業       |
| 2        | 佐藤花子   | sato@example.com   | 営業1課    | 10         | 一般営業       |
| 3        | 鈴木一郎   | suzuki@example.com | 営業1課    | 10         | 一般営業       |
| 10       | 田中課長   | tanaka@example.com | 営業部     | NULL       | 上長           |
| 99       | 管理者     | admin@example.com  | 管理部     | NULL       | システム管理者 |

### 2.2 顧客マスタ（Customer）

| customer_id | customer_name | industry | sales_id |
| ----------- | ------------- | -------- | -------- |
| 50          | ABC商事       | 製造業   | 1        |
| 51          | XYZ株式会社   | IT業     | 1        |
| 52          | DEF物産       | 商社     | 2        |

---

## 3. テストケース

### 3.1 認証機能

#### TC-AUTH-001: ログイン成功

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 営業マスタに山田太郎が登録済み
  - メール: yamada@example.com
  - パスワード: password123
- **テスト手順**:
  1. POST /auth/login にメールアドレスとパスワードを送信
- **期待結果**:
  - ステータスコード: 200
  - レスポンスにJWTトークンとユーザー情報が含まれる
  - トークンが有効である

#### TC-AUTH-002: ログイン失敗（パスワード不正）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**: 営業マスタに山田太郎が登録済み
- **テスト手順**:
  1. POST /auth/login に正しいメールアドレスと誤ったパスワードを送信
- **期待結果**:
  - ステータスコード: 401
  - エラーコード: INVALID_CREDENTIALS
  - エラーメッセージが返される

#### TC-AUTH-003: ログイン失敗（存在しないユーザー）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**: なし
- **テスト手順**:
  1. POST /auth/login に存在しないメールアドレスを送信
- **期待結果**:
  - ステータスコード: 401
  - エラーコード: INVALID_CREDENTIALS

#### TC-AUTH-004: トークンリフレッシュ

- **テスト種別**: IT
- **優先度**: 中
- **前提条件**: 有効なJWTトークンを取得済み
- **テスト手順**:
  1. POST /auth/refresh に有効なトークンを付与して送信
- **期待結果**:
  - ステータスコード: 200
  - 新しいJWTトークンが返される

#### TC-AUTH-005: 認証なしでAPIアクセス

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**: なし
- **テスト手順**:
  1. GET /daily-reports に認証ヘッダーなしでアクセス
- **期待結果**:
  - ステータスコード: 401
  - エラーメッセージが返される

---

### 3.2 日報管理機能

#### TC-REPORT-001: 日報新規作成（下書き）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**: 山田太郎でログイン済み
- **テスト手順**:
  1. POST /daily-reports に以下を送信
     - report_date: 2026-02-05
     - problem: テスト課題
     - plan: テスト計画
     - status: draft
- **期待結果**:
  - ステータスコード: 201
  - 日報が下書きとして作成される
  - created_atとupdated_atが設定される

#### TC-REPORT-002: 日報新規作成（提出）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**: 山田太郎でログイン済み
- **テスト手順**:
  1. POST /daily-reports に status: submitted で送信
- **期待結果**:
  - ステータスコード: 201
  - 日報が提出済みとして作成される

#### TC-REPORT-003: 同一日の日報重複作成エラー

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 山田太郎でログイン済み
  - 2026-02-05の日報が既に存在
- **テスト手順**:
  1. POST /daily-reports に report_date: 2026-02-05 で送信
- **期待結果**:
  - ステータスコード: 400
  - エラーコード: DUPLICATE_REPORT

#### TC-REPORT-004: 日報一覧取得（自分）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 山田太郎でログイン済み
  - 山田太郎の日報が複数存在
- **テスト手順**:
  1. GET /daily-reports?start_date=2026-02-01&end_date=2026-02-05
- **期待結果**:
  - ステータスコード: 200
  - 自分の日報のみが返される
  - ページネーション情報が含まれる

#### TC-REPORT-005: 日報詳細取得（訪問記録とコメント含む）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 山田太郎でログイン済み
  - report_id: 123 の日報が存在し、訪問記録とコメントがある
- **テスト手順**:
  1. GET /daily-reports/123
- **期待結果**:
  - ステータスコード: 200
  - 日報本体、訪問記録リスト、コメントリストが含まれる

#### TC-REPORT-006: 日報更新（本人）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 山田太郎でログイン済み
  - 山田太郎が作成した日報が存在
- **テスト手順**:
  1. PUT /daily-reports/123 で problem と plan を更新
- **期待結果**:
  - ステータスコード: 200
  - 日報内容が更新される
  - updated_atが更新される

#### TC-REPORT-007: 日報更新（他人の日報）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 山田太郎でログイン済み
  - 佐藤花子が作成した日報が存在
- **テスト手順**:
  1. PUT /daily-reports/124（佐藤の日報）で更新を試みる
- **期待結果**:
  - ステータスコード: 403
  - エラーコード: PERMISSION_DENIED

#### TC-REPORT-008: 日報削除（下書き）

- **テスト種別**: IT
- **優先度**: 中
- **前提条件**:
  - 山田太郎でログイン済み
  - status: draft の日報が存在
- **テスト手順**:
  1. DELETE /daily-reports/125
- **期待結果**:
  - ステータスコード: 200
  - 日報が削除される

#### TC-REPORT-009: 日報削除（提出済み）エラー

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 山田太郎でログイン済み
  - status: submitted の日報が存在
- **テスト手順**:
  1. DELETE /daily-reports/123
- **期待結果**:
  - ステータスコード: 400
  - エラーコード: CANNOT_DELETE_SUBMITTED

#### TC-REPORT-010: 部下の日報一覧取得（上長）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 田中課長でログイン済み
  - 部下（山田、佐藤、鈴木）の日報が存在
- **テスト手順**:
  1. GET /daily-reports/subordinates?start_date=2026-02-01&end_date=2026-02-05
- **期待結果**:
  - ステータスコード: 200
  - 部下3名の日報が全て返される
  - 他の営業の日報は含まれない

#### TC-REPORT-011: 部下の日報取得（一般営業）エラー

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**: 山田太郎（一般営業）でログイン済み
- **テスト手順**:
  1. GET /daily-reports/subordinates
- **期待結果**:
  - ステータスコード: 403
  - エラーコード: PERMISSION_DENIED

---

### 3.3 訪問記録管理機能

#### TC-VISIT-001: 訪問記録追加

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 山田太郎でログイン済み
  - report_id: 123 の日報が存在
  - customer_id: 50 の顧客が存在
- **テスト手順**:
  1. POST /daily-reports/123/visits に以下を送信
     - customer_id: 50
     - visit_time: 10:00:00
     - visit_content: テスト訪問内容
- **期待結果**:
  - ステータスコード: 201
  - 訪問記録が作成される
  - 顧客名が含まれる

#### TC-VISIT-002: 訪問記録追加（存在しない顧客）エラー

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 山田太郎でログイン済み
  - report_id: 123 の日報が存在
- **テスト手順**:
  1. POST /daily-reports/123/visits に存在しない customer_id: 999 を指定
- **期待結果**:
  - ステータスコード: 400
  - エラーメッセージが返される

#### TC-VISIT-003: 訪問記録更新

- **テスト種別**: IT
- **優先度**: 中
- **前提条件**:
  - 山田太郎でログイン済み
  - visit_id: 301 の訪問記録が存在
- **テスト手順**:
  1. PUT /visits/301 で visit_content を更新
- **期待結果**:
  - ステータスコード: 200
  - 訪問内容が更新される

#### TC-VISIT-004: 訪問記録削除

- **テスト種別**: IT
- **優先度**: 中
- **前提条件**:
  - 山田太郎でログイン済み
  - visit_id: 302 の訪問記録が存在
- **テスト手順**:
  1. DELETE /visits/302
- **期待結果**:
  - ステータスコード: 200
  - 訪問記録が削除される

#### TC-VISIT-005: 他人の訪問記録更新エラー

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 山田太郎でログイン済み
  - 佐藤花子の訪問記録が存在
- **テスト手順**:
  1. PUT /visits/400（佐藤の訪問記録）で更新を試みる
- **期待結果**:
  - ステータスコード: 403
  - エラーコード: PERMISSION_DENIED

---

### 3.4 コメント機能

#### TC-COMMENT-001: コメント追加（上長）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 田中課長でログイン済み
  - 部下の日報 report_id: 123 が存在
- **テスト手順**:
  1. POST /daily-reports/123/comments に以下を送信
     - comment_content: テストコメント
- **期待結果**:
  - ステータスコード: 201
  - コメントが作成される
  - commenter_name が田中課長となる

#### TC-COMMENT-002: コメント追加（一般営業）エラー

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 山田太郎でログイン済み
  - 佐藤花子の日報が存在
- **テスト手順**:
  1. POST /daily-reports/124/comments にコメントを追加
- **期待結果**:
  - ステータスコード: 403
  - エラーコード: PERMISSION_DENIED

#### TC-COMMENT-003: 自分の日報にコメント追加エラー

- **テスト種別**: IT
- **優先度**: 中
- **前提条件**:
  - 山田太郎でログイン済み
  - 自分の日報が存在
- **テスト手順**:
  1. POST /daily-reports/123/comments にコメントを追加
- **期待結果**:
  - ステータスコード: 403
  - 自分の日報にはコメントできない

#### TC-COMMENT-004: コメント更新

- **テスト種別**: IT
- **優先度**: 中
- **前提条件**:
  - 田中課長でログイン済み
  - 自分が投稿したコメントが存在
- **テスト手順**:
  1. PUT /comments/201 でコメント内容を更新
- **期待結果**:
  - ステータスコード: 200
  - コメント内容が更新される

#### TC-COMMENT-005: コメント削除

- **テスト種別**: IT
- **優先度**: 中
- **前提条件**:
  - 田中課長でログイン済み
  - 自分が投稿したコメントが存在
- **テスト手順**:
  1. DELETE /comments/201
- **期待結果**:
  - ステータスコード: 200
  - コメントが削除される

---

### 3.5 顧客マスタ管理機能

#### TC-CUSTOMER-001: 顧客一覧取得

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - ログイン済み
  - 顧客マスタにデータが存在
- **テスト手順**:
  1. GET /customers
- **期待結果**:
  - ステータスコード: 200
  - 顧客一覧が返される
  - ページネーション情報が含まれる

#### TC-CUSTOMER-002: 顧客検索（キーワード）

- **テスト種別**: IT
- **優先度**: 中
- **前提条件**: 顧客マスタにABC商事が存在
- **テスト手順**:
  1. GET /customers?keyword=ABC
- **期待結果**:
  - ステータスコード: 200
  - ABC商事が検索結果に含まれる

#### TC-CUSTOMER-003: 顧客詳細取得（訪問履歴含む）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - customer_id: 50 が存在
  - 該当顧客への訪問記録が存在
- **テスト手順**:
  1. GET /customers/50
- **期待結果**:
  - ステータスコード: 200
  - 顧客情報と訪問履歴が返される

#### TC-CUSTOMER-004: 顧客登録

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**: ログイン済み
- **テスト手順**:
  1. POST /customers に以下を送信
     - customer_name: テスト株式会社
     - industry: IT業
     - sales_id: 1
- **期待結果**:
  - ステータスコード: 201
  - 顧客が作成される

#### TC-CUSTOMER-005: 顧客更新

- **テスト種別**: IT
- **優先度**: 中
- **前提条件**: customer_id: 50 が存在
- **テスト手順**:
  1. PUT /customers/50 で customer_name を更新
- **期待結果**:
  - ステータスコード: 200
  - 顧客情報が更新される

#### TC-CUSTOMER-006: 顧客削除（訪問記録なし）

- **テスト種別**: IT
- **優先度**: 中
- **前提条件**:
  - 管理者でログイン済み
  - 訪問記録のない顧客が存在
- **テスト手順**:
  1. DELETE /customers/60
- **期待結果**:
  - ステータスコード: 200
  - 顧客が削除される

#### TC-CUSTOMER-007: 顧客削除（訪問記録あり）エラー

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 管理者でログイン済み
  - customer_id: 50 に訪問記録が存在
- **テスト手順**:
  1. DELETE /customers/50
- **期待結果**:
  - ステータスコード: 400
  - エラーコード: CUSTOMER_HAS_VISITS

---

### 3.6 営業マスタ管理機能

#### TC-SALES-001: 営業一覧取得（管理者）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**: 管理者でログイン済み
- **テスト手順**:
  1. GET /sales
- **期待結果**:
  - ステータスコード: 200
  - 営業一覧が返される

#### TC-SALES-002: 営業一覧取得（一般営業）エラー

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**: 山田太郎（一般営業）でログイン済み
- **テスト手順**:
  1. GET /sales
- **期待結果**:
  - ステータスコード: 403
  - エラーコード: PERMISSION_DENIED

#### TC-SALES-003: 部下一覧取得（上長）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**: 田中課長でログイン済み
- **テスト手順**:
  1. GET /sales/subordinates
- **期待結果**:
  - ステータスコード: 200
  - 部下3名のリストが返される

#### TC-SALES-004: 営業登録（管理者）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**: 管理者でログイン済み
- **テスト手順**:
  1. POST /sales に以下を送信
     - sales_name: 新人太郎
     - email: newbie@example.com
     - password: password123
     - manager_id: 10
- **期待結果**:
  - ステータスコード: 201
  - 営業が作成される

#### TC-SALES-005: 営業登録（メール重複）エラー

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 管理者でログイン済み
  - yamada@example.com が既に存在
- **テスト手順**:
  1. POST /sales に email: yamada@example.com で送信
- **期待結果**:
  - ステータスコード: 400
  - エラーコード: EMAIL_ALREADY_EXISTS

#### TC-SALES-006: 営業更新

- **テスト種別**: IT
- **優先度**: 中
- **前提条件**: 管理者でログイン済み
- **テスト手順**:
  1. PUT /sales/1 で department を更新
- **期待結果**:
  - ステータスコード: 200
  - 営業情報が更新される

#### TC-SALES-007: 営業削除（日報なし）

- **テスト種別**: IT
- **優先度**: 中
- **前提条件**:
  - 管理者でログイン済み
  - 日報のない営業が存在
- **テスト手順**:
  1. DELETE /sales/20
- **期待結果**:
  - ステータスコード: 200
  - 営業が削除される

#### TC-SALES-008: 営業削除（日報あり）エラー

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 管理者でログイン済み
  - sales_id: 1 に日報が存在
- **テスト手順**:
  1. DELETE /sales/1
- **期待結果**:
  - ステータスコード: 400
  - 日報がある営業は削除できない

---

### 3.7 ダッシュボード機能

#### TC-DASHBOARD-001: ダッシュボード情報取得（一般営業）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**:
  - 山田太郎でログイン済み
  - 今週の日報と訪問記録が存在
- **テスト手順**:
  1. GET /dashboard
- **期待結果**:
  - ステータスコード: 200
  - 週次サマリー（訪問数、日報提出数）が含まれる
  - 最近の日報が含まれる
  - 部下の日報セクションは含まれない

#### TC-DASHBOARD-002: ダッシュボード情報取得（上長）

- **テスト種別**: IT
- **優先度**: 高
- **前提条件**: 田中課長でログイン済み
- **テスト手順**:
  1. GET /dashboard
- **期待結果**:
  - ステータスコード: 200
  - 自分のサマリーが含まれる
  - 部下の日報サマリーが含まれる

---

## 4. システムテスト（シナリオベース）

### 4.1 シナリオ: 営業の1日の業務フロー

#### ST-SCENARIO-001: 日報作成から上長コメントまでの一連の流れ

- **テスト種別**: ST
- **優先度**: 高
- **前提条件**: テストデータが投入済み
- **テスト手順**:
  1. 山田太郎でログイン
  2. ダッシュボードから「今日の日報を作成」をクリック
  3. 訪問記録を2件追加（ABC商事、XYZ株式会社）
  4. Problemに課題を記入
  5. Planに明日の予定を記入
  6. 下書き保存
  7. 内容確認後、「提出する」をクリック
  8. ログアウト
  9. 田中課長でログイン
  10. 部下の日報一覧から山田の日報を開く
  11. コメントを追加
  12. ログアウト
  13. 山田太郎で再ログイン
  14. ダッシュボードで未読コメント通知を確認
  15. 日報詳細でコメントを閲覧

- **期待結果**:
  - 各ステップが正常に動作する
  - コメント通知が正しく表示される
  - データの整合性が保たれる

---

## 5. 非機能テスト

### 5.1 パフォーマンステスト

#### NFT-PERF-001: 日報一覧の表示速度

- **テスト種別**: パフォーマンス
- **優先度**: 中
- **テスト内容**: 1000件の日報データがある状態で一覧取得
- **期待結果**: レスポンスタイムが2秒以内

#### NFT-PERF-002: 同時ログイン

- **テスト種別**: 負荷テスト
- **優先度**: 中
- **テスト内容**: 50ユーザーが同時にログイン
- **期待結果**: 全てのログインが10秒以内に完了

### 5.2 セキュリティテスト

#### NFT-SEC-001: SQLインジェクション対策

- **テスト種別**: セキュリティ
- **優先度**: 高
- **テスト内容**: 検索フィールドにSQLインジェクションコードを入力
- **期待結果**: SQLインジェクションが実行されない

#### NFT-SEC-002: XSS対策

- **テスト種別**: セキュリティ
- **優先度**: 高
- **テスト内容**: コメントにスクリプトタグを含む文字列を入力
- **期待結果**: スクリプトがエスケープされて表示される

#### NFT-SEC-003: 権限チェック

- **テスト種別**: セキュリティ
- **優先度**: 高
- **テスト内容**: 一般営業が管理者APIに直接アクセス
- **期待結果**: 403エラーが返される

---

## 6. 受け入れテスト

### 6.1 ユーザー受け入れ基準

#### UAT-001: 営業担当者の日報作成がスムーズに行える

- **テスト内容**: 実際のユーザーが日報を作成
- **合格基準**: 5分以内に日報作成が完了できる

#### UAT-002: 上長が部下の日報を確認しコメントできる

- **テスト内容**: 上長が部下の日報を確認しコメント
- **合格基準**: 操作に迷わず完了できる

#### UAT-003: 顧客情報の検索と選択が直感的

- **テスト内容**: 訪問記録追加時の顧客選択
- **合格基準**: 3クリック以内で顧客を選択できる

---

## 7. テスト実施スケジュール

| フェーズ       | 期間       | 担当        |
| -------------- | ---------- | ----------- |
| 単体テスト     | 開発と並行 | 開発者      |
| 結合テスト     | 2日間      | QAチーム    |
| システムテスト | 3日間      | QAチーム    |
| 受け入れテスト | 2日間      | ユーザー+QA |

---

## 8. バグ管理

### 8.1 バグの優先度

- **Critical**: システムが動作しない、データ損失の危険
- **High**: 主要機能が動作しない
- **Medium**: 一部機能に問題がある
- **Low**: UIの軽微な問題

### 8.2 バグ報告フォーマット

- バグID
- テストケースID
- 優先度
- 再現手順
- 期待結果
- 実際の結果
- スクリーンショット（必要に応じて）

---

## 9. テスト完了基準

- 全ての優先度「高」のテストケースが合格
- Critical/Highのバグがゼロ
- Mediumバグが10件以下
- コードカバレッジが80%以上
- ユーザー受け入れテストが完了

# 使用技術

**言語:** TypeScript
**フレームワーク** Next.js(App Router)
**UIコンポーネント** shadcn/ui + Tailwind CSS
**APIスキーマ定義** OpenAPI(Zodによる検証)
**DBスキーマ定義** Prisma.js
**テスト** Vitest
**デプロイ** Google Cloud Run
